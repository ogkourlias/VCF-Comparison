---
title: "chrSummary"
author: "Orfeas Gkourlias"
date: "20/12/2023"
output: pdf_document
---

```{r setup, results='hide', message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("ggplot2")
library("stringr")
library(dplyr)
library(hrbrthemes)
```

```{r}
read_tsv <- function(file_name) {
  df <- read.csv(file_name, sep = "\t", header = TRUE)
  return(df)
}

get_ratios <- function(list_entry) {
  chr <- str_match(list_entry[[1]][1], ".*chr[0-9]{1,2}")
  df <- data.frame(chr=chr, ratio = list_entry[[11]])
  return(df)
}

```

```{r}
file_names <- list.files("tsv/",pattern = "*.tsv", full.names = TRUE)
main_df <- do.call(rbind,lapply(file_names,read.csv, sep = "\t", header = TRUE))
main_df$chr <- mapply(str_match, main_df$var_id, pattern = ".*chr[0-9]{1,2}")
```

```{r}
ratio_mean = mean(main_df$match_ratio, na.rm = TRUE)
boxplots <- ggplot(main_df, aes(x=chr, y=match_ratio, fill=chr)) +
  xlab("") + ylab("GT Overlap\n") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_boxplot() 
boxplots <- boxplots + geom_hline(yintercept = ratio_mean, linetype="solid", 
                color = "blue", size=1) + ggtitle("GT Overlap between 1,079,268 Variants from 147 samples (Before VCF filter).\n")
ggsave(
  "figures/overlap1.png",
  plot = last_plot(),
  scale = 1,
  width = 12,
  height = 8,
  dpi = 300
)
```
  
```{r}
ratios_c <- seq(0.01, 1, by=0.01)
coverage <- sapply(ratios_c, function(x) nrow(main_df[main_df$match_ratio >= x,]) / nrow(main_df))
```

```{r}
plot(y = coverage, x = ratios_c, xlab = "Overlap Ratio", ylab = "Coverage Percentage")
```
```{r}
main_df$nrhoma_diff = main_df$nrhoma_i - main_df$nrhoma_r
main_df$nrhets_diff = main_df$nrhets_i - main_df$nrhets_r
main_df$nrhomb_diff = main_df$nrhomb_i - main_df$nrhomb_r
```

```{r}
boxplots <- ggplot(main_df, aes(x=chr, y=nrhoma_diff, fill=chr)) +
  xlab("") + ylab("GT Overlap\n") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_boxplot() 
boxplots <- boxplots + geom_hline(yintercept = ratio_mean, linetype="solid", 
                color = "blue", size=1, outlier.shape = NA) + ggtitle("nhoma_diff.\n") +
            scale_y_log10()
ggsave(
  "figures/nhoma_diff.png",
  plot = last_plot(),
  scale = 1,
  width = 12,
  height = 8,
  dpi = 300
)

boxplots <- ggplot(main_df, aes(x=chr, y=nrhets_diff, fill=chr)) +
  xlab("") + ylab("GT Overlap\n") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_boxplot() 
boxplots <- boxplots + geom_hline(yintercept = ratio_mean, linetype="solid", 
                color = "blue", size=1) + ggtitle("nrhets_diff\n")
ggsave(
  "figures/nrhets_diff.png",
  plot = last_plot(),
  scale = 1,
  width = 12,
  height = 8,
  dpi = 300
)

boxplots <- ggplot(main_df, aes(x=chr, y=nrhomb_diff, fill=chr)) +
  xlab("") + ylab("GT Overlap\n") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_boxplot() 
boxplots <- boxplots + geom_hline(yintercept = ratio_mean, linetype="solid", 
                color = "blue", size=1) + ggtitle("nrhomb_diff\n")
ggsave(
  "figures/nrhomb_diff.png",
  plot = last_plot(),
  scale = 1,
  width = 12,
  height = 8,
  dpi = 300
)
```

```{r}
p_scor <- cor(main_df$match_ratio, main_df$p_corr, use = "complete.obs")
s_cor <- cor(main_df$match_ratio, main_df$s_corr, use = "complete.obs")
```

```{r}
# Hexbin chart with default option
#ggplot(main_df, aes(x=p_corr, y=match_ratio) ) +
  #geom_hex() +
  #theme_bw()
 
# Bin size control + color palette
#ggplot(main_df, aes(x=p_corr, y=match_ratio) ) +
  #geom_hex(bins = 100) +
  #scale_fill_continuous(type = "viridis") +
  #theme_bw()
```
```{r}
main_df$alt_freq_i <- ifelse(main_df$maf_type_i == "ALT", main_df$maf_i, 1 - main_df$maf_i)
main_df$alt_freq_r <- ifelse(main_df$maf_type_r == "ALT", main_df$maf_r, 1 - main_df$maf_r)
main_df$ref_freq_i <- 1 - main_df$alt_freq_i
main_df$ref_freq_r <- 1 - main_df$alt_freq_r 

# basic scatterplot
ggplot(main_df, aes(x=alt_freq_i, y=alt_freq_r)) +
    geom_point(alpha = 0.05)

cor(main_df$alt_freq_i, main_df$alt_freq_r)

ggplot(main_df, aes(x=ref_freq_i, y=ref_freq_r)) +
    geom_point(alpha = 0.05)

cor(main_df$ref_freq_i, main_df$ref_freq_r)
```

```{r}
main_df$call_rate_i <- (1 - main_df$missing_i / main_df$gt_total)
main_df$call_rate_r <- (1 - main_df$missing_r / main_df$gt_total)

cr50df <- main_df[(main_df$call_rate_i >= 0.5) & (main_df$call_rate_i >= 0.5),]

# basic scatterplot
ggplot(cr50df, aes(x=alt_freq_i, y=alt_freq_r)) +
    geom_point(alpha = 0.05)

cor(cr50df$alt_freq_i, cr50df$alt_freq_r)

ggplot(cr50df, aes(x=ref_freq_i, y=ref_freq_r)) +
    geom_point(alpha = 0.05)

cor(cr50df$ref_freq_i, cr50df$ref_freq_r)
```

```{r}
ggplot(main_df, aes(x=-log10(hwe_i), y=-log10(hwe_r))) +
    geom_point(alpha = 0.05)

cor(main_df$hwe_i, main_df$hwe_r)
```


